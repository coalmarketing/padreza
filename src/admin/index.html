<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicons -->
    <link
      rel="icon"
      type="image/png"
      href="/assets/favicons/favicon-96x96.png"
      sizes="96x96"
    />
    <link rel="icon" type="image/svg+xml" href="/assets/favicons/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicons/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/favicons/apple-touch-icon.png"
    />
    <link rel="manifest" href="/assets/favicons/site.webmanifest" />

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("logout", () => {
          document.location.href = "/admin/";
        });

        window.netlifyIdentity.setLocale("cs");
      }
    </script>

    <title>Správa obsahu</title>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.8.3/dist/decap-cms.js"></script>
    <script src="preview.js"></script>

    <!-- Documentation: https://decapcms.org/docs/customization/ -->
    <script>
      // Register the styles for the "blog" collection
      CMS.registerPreviewStyle("/admin/decap-preview-styles.css");

      if (window.CMS) {
        window.CMS.registerEventListener({
          name: "postSave",
          handler: async ({ entry }) => {
            const hash = window.location.hash;
            const match = hash.match(
              /#\/collections\/([^/]+)\/entries\/([^/]+)/
            );
            if (!match) return;

            const collection = match[1];
            const entryId = match[2];

            try {
              // 1️⃣ Najdi existující záznamy v store
              const state = window.CMS.store.getState();
              const currentEntries = state.entries?.[collection] || [];

              // 2️⃣ Pokud nový záznam, přidej ho do store
              const exists = currentEntries.some((e) => e.id === entryId);
              if (!exists) {
                window.CMS.store.dispatch({
                  type: "ENTRIES_ADD",
                  payload: {
                    collection,
                    entries: [entry],
                  },
                });
              }

              // 3️⃣ Přepni UI zpět do seznamu kolekce
              window.CMS.store.dispatch({
                type: "NAVIGATE",
                payload: { view: "collection", collection },
              });

              console.log(
                `Po uložení byl návrat do seznamu kolekce "${collection}"`
              );
            } catch (err) {
              console.error("Chyba při návratu do seznamu kolekce:", err);
            }
          },
        });
      }
    </script>
  </body>
</html>
